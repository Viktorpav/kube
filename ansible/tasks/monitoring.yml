- name: Install Prometheus stack without persistence
  kubernetes.core.helm:
    name: monitoring
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: monitoring
    create_namespace: true
    wait: true
    wait_timeout: 45m
    values:
      grafana:
        adminPassword: "{{ grafana_admin_password }}"
        persistence:
          enabled: false # disable PVC
      prometheus:
        prometheusSpec:
          storageSpec:
            volumeClaimTemplate: null # disable PVC
          retention: 7d
      alertmanager:
        alertmanagerSpec:
          storage:
            volumeClaimTemplate: null # disable PVC
  run_once: true

- name: Wait for all monitoring pods to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: monitoring
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 600
  run_once: true
# - name: Install Prometheus stack
#   kubernetes.core.helm:
#     name: monitoring
#     chart_ref: prometheus-community/kube-prometheus-stack
#     release_namespace: monitoring
#     create_namespace: true
#     wait: true
#     wait_timeout: 45m
#     values:
#       grafana:
#         adminPassword: "{{ grafana_admin_password }}"
#         persistence:
#           enabled: true
#           storageClassName: rook-ceph-block
#           size: 2Gi
#       prometheus:
#         prometheusSpec:
#           storageSpec:
#             volumeClaimTemplate:
#               spec:
#                 storageClassName: rook-ceph-block
#                 resources:
#                   requests:
#                     storage: 5Gi
#           retention: 7d
#       alertmanager:
#         alertmanagerSpec:
#           storage:
#             volumeClaimTemplate:
#               spec:
#                 storageClassName: rook-ceph-block
#                 resources:
#                   requests:
#                     storage: 1Gi
#   run_once: true
